## 📋 修改計劃總覽

根據「GPU紀錄查詢API」需求文件，我需要為專案新增一個專門的查詢端點，主要變更如下：

***

## 🎯 需求分析

### 新API需求重點：
1. **時間範圍限制**：只查詢每天 8:00-20:00 的資料（12小時）
2. **資料採樣**：每小時取**最高使用率**（而非平均值）
3. **超過90%計算**：計算每小時內使用率超過90%的**持續分鐘數**
4. **平均值計算**：所有平均值以12小時為分母（而非24小時）
5. **回傳格式**：包含統計數據、每小時最高使用率、每小時超過90%持續時間

***

## 🔧 詳細修改計劃

### 1️⃣ **Server端修改** (`server.py`)

#### **1.1 新增 Schema 定義**
在 Marshmallow 資料模型區域新增：

```python
class GPUHistoryQuerySchema(Schema):
    """GPU紀錄查詢請求模型"""
    class Meta:
        unknown = EXCLUDE
    
    start_date = fields.Str(required=True)   # 格式：YYYY-MM-DD
    end_date = fields.Str(required=True)     # 格式：YYYY-MM-DD
    gpu_id = fields.Int(required=True)       # GPU ID，0=署內，1=藥商
```

***

#### **1.2 新增核心計算方法** (在 `GPUMetricsServer` 類別中)

**方法 A：`filter_working_hours()` - 篩選工作時段資料**
```python
def filter_working_hours(self, df: pd.DataFrame) -> pd.DataFrame:
    """
    篩選每天 8:00-20:00 的資料
    
    Args:
        df: 原始資料 DataFrame
        
    Returns:
        僅包含 8:00-20:00 時段的 DataFrame
    """
    # 實作：過濾 hour 欄位在 8-19 之間（20:00 不包含）
```

**方法 B：`calculate_hourly_max_utilization()` - 計算每小時最高使用率**
```python
def calculate_hourly_max_utilization(self, df: pd.DataFrame) -> List[Dict[str, Any]]:
    """
    計算每小時的最高使用率
    
    邏輯：
    - 以 (date, hour) 為群組
    - 取該小時內所有紀錄的 MAX(utilization_gpu)
    - 返回格式：[{"date": "2024-11-02", "hour": 8, "max_utilization": 45.2}, ...]
    """
```

**方法 C：`calculate_over90_duration()` - 計算超過90%持續時間**
```python
def calculate_over90_duration(self, df: pd.DataFrame) -> List[Dict[str, Any]]:
    """
    計算每小時內使用率超過90%的持續分鐘數
    
    邏輯：
    - 目前每5秒抓一次 → 12筆/分鐘
    - 計算每小時內 utilization_gpu > 90 的紀錄數
    - 將紀錄數轉換為分鐘數（紀錄數 / 12）
    - 返回格式：[{"date": "2024-11-02", "hour": 8, "duration": 12.5}, ...]
    """
```

**方法 D：`calculate_statistics_12h()` - 計算12小時統計**
```python
def calculate_statistics_12h(self, df: pd.DataFrame) -> Dict[str, float]:
    """
    計算基於12小時工作時段的統計數據
    
    返回：
    {
        "hourly_average": 每小時平均使用率（12小時內所有小時的平均）,
        "daily_average": 每日平均使用率（每日12小時最高值的平均）,
        "period_average": 期間平均使用率（所有資料的平均）,
        "max_utilization": 最高使用率,
        "min_utilization": 最低使用率
    }
    """
```

***

#### **1.3 新增 API 端點**

```python
@app.route("/api/gpu/query-history", methods=["POST"])
@validate_request_data(GPUHistoryQuerySchema)
def query_gpu_history(validated_data):
    """
    GPU紀錄查詢API
    
    處理流程：
    1. 載入 CSV 資料
    2. 依 start_date, end_date, gpu_id 篩選
    3. 篩選 8:00-20:00 時段
    4. 計算統計數據（12小時基準）
    5. 計算每小時最高使用率
    6. 計算每小時超過90%持續時間
    7. 組合回應
    
    Returns:
        {
            "code": 200,
            "message": "",
            "data": {
                "statistics": {...},
                "hourly_max_usage": [...],
                "hourly_over90_duration": [...]
            }
        }
    """
```

***

### 2️⃣ **回應格式調整**

將現有的 `{"success": true, "data": {...}}` 格式改為新需求的格式：
```python
{
    "code": 200,
    "message": "",
    "data": {
        "statistics": {
            "hourly_average": 65.5,
            "daily_average": 68.2,
            "period_average": 70.1,
            "max_utilization": 95.3,
            "min_utilization": 12.5
        },
        "hourly_max_usage": [
            {"date": "2024-11-02", "hour": 8, "max_utilization": 45.2},
            ...
        ],
        "hourly_over90_duration": [
            {"date": "2024-11-02", "hour": 8, "duration": 12.5},
            ...
        ]
    }
}
```

***

### 3️⃣ **資料處理邏輯重點**

#### **時間篩選**
```python
# 只保留 8:00-19:59 的資料
filtered_df = df[(df['hour'] >= 8) & (df['hour'] < 20)]
```

#### **每小時最高值**
```python
# 按日期和小時分組，取最大值
hourly_max = df.groupby(['date', 'hour'])['utilization_gpu'].max()
```

#### **超過90%計算**
```python
# 篩選超過90%的紀錄
over90 = df[df['utilization_gpu'] > 90]
# 計算每小時數量並轉換為分鐘
duration_minutes = over90.groupby(['date', 'hour']).size() / 12  # 每5秒一筆 = 12筆/分鐘
```

#### **12小時平均**
```python
# 確保只在8:00-20:00的12小時內計算平均
hourly_avg = filtered_df.groupby(['date', 'hour'])['utilization_gpu'].mean().mean()
```

***

## 🔍 與現有API的差異

| 項目 | 現有API | 新API |
|-----|---------|-------|
| 時間範圍 | 全天24小時 | 僅8:00-20:00 |
| 使用率計算 | 平均值 | 最高值 |
| 平均分母 | 24小時 | 12小時 |
| 超過90%計算 | 無 | 有（分鐘數） |
| 回應格式 | `{"success": true}` | `{"code": 200}` |

***

## ✅ 預期效果

完成後將提供：
- ✅ 符合需求的專用查詢API
- ✅ 8:00-20:00工作時段資料篩選
- ✅ 每小時最高使用率統計
- ✅ 每小時超過90%持續時間計算
- ✅ 12小時基準的平均值計算
- ✅ 保持現有API功能不受影響